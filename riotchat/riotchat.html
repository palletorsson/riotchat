<head>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
    <script> var JsonFormatter = {
        stringify: function (cipherParams) {
            // create json object with ciphertext
            var jsonObj = {
                ct: cipherParams.ciphertext.toString(CryptoJS.enc.Base64)
            };

            // optionally add iv and salt
            if (cipherParams.iv) {
                jsonObj.iv = cipherParams.iv.toString();
            }
            if (cipherParams.salt) {
                jsonObj.s = cipherParams.salt.toString();
            }

            // stringify json object
            return JSON.stringify(jsonObj);
        },

        parse: function (jsonStr) {
            // parse json string
            var jsonObj = JSON.parse(jsonStr);

            // extract ciphertext from json object, and create cipher params object
            var cipherParams = CryptoJS.lib.CipherParams.create({
                ciphertext: CryptoJS.enc.Base64.parse(jsonObj.ct)
            });

            // optionally extract iv and salt
            if (jsonObj.iv) {
                cipherParams.iv = CryptoJS.enc.Hex.parse(jsonObj.iv)
            }
            if (jsonObj.s) {
                cipherParams.salt = CryptoJS.enc.Hex.parse(jsonObj.s)
            }

            return cipherParams;
        }
    };
	</script>

	<title>Riot chat</title>
</head>

<body>
<div id="wrap">
	{{> admin_panel}}
    {{> header}}
	<div>
	
	</div>
	<div>
		{{> gameboard}}
		{{> avatarList}}
		
	</div>
 </div> 

</body>

<template name="admin_panel">
	<div class="admin_panel_active"></div>
</template>

<template name="header">
	<div class="navbar navbar-default navbar-fixed-top">
		<div class="navbar-inner">
		    <div class="container">
			<ul class="nav navbar-nav">  
		      	<li>
			{{#if currentUser}}	
				{{> chat}}		
			{{else}}	
				{{> chat_not_logged_in}}
			{{/if}}
				</li>
		    </ul>      
		
		    <ul class="nav navbar-nav navbar-left pull-left">
		       	<li>
					{{#if currentUser}}
						{{> avatarForm}}
					{{/if}}
				</li>
		    </ul>
		    <ul class="nav navbar-nav navbar-right pull-right login_buttons">
		        <li>
					{{>loginButtons}} 
				</li>
			</ul>
			</div>	
		</div>	
	</div>	
</template>


<template name="secret_form">
	<div class="accounts-dialog edit_key_overlay">
		{{#if changing_secret}}
			Secret ( <a id="close_secret">Close</a> ) :<input type="password" id="pass" name="p">
		{{else}}
			<a id="change_secret" class="login-link-text">Chat secret ▾</a>
		{{/if}}			
	</div>
</template>

<template name="avatarForm">
<div class="accounts-dialog edit_avatar_overlay">
		{{#if editing}}
			<h4>{{avatar.avatar_name}} Settings ( <a id="cancel_edit">x</a> ) </h4>
			<form class="form-inline" role="form">

			  <div class="form-group">
				<label class="sr-only" for="name">Nic:</label>
				<input type="text" id="avatar_name" class="form-control" value="{{avatar.avatar_name}}">
			  </div>  	
			  <div class="form-group">
				<label class="sr-only" for="message">Message:</label>
				<input type="text" id="avatar_message" class="form-control" value="{{avatar.avatar_message}}">
			  </div>
			  <div class="form-group">
				<label class="sr-only" for="image">Select riot Avatar:</label>

				{{> avatar_choose}}
				
				<div style="clear:both"></div>
				 Selected avatar: <input type="text" id="avatar_image_input" value="{{avatar.avatar_img}}">
			  </div>	
				<input type="hidden" value="{{avatar.avatar_id}}">
			  	<button class="btn btn-primary" id="change">change</button>
			</form>
		{{else}}
			<a  id="edit" class="login-link-text">
				{{#if avatar}}
	       			You ▾
				{{else}}
					Configure your avatar and nic ▾
				{{/if}}

    		</a>
		{{/if}}
	</div>
</template>

<template name="avatar_choose">
 	<div class="checkbox_div">	
	{{#each avatars}}
		<div class="checkbox_container">
			<div>  
				<a href="#" class="choose_avatar" id="{{name}}" name="{{name}}.{{type}}"><img src="img/{{name}}.{{type}}"  class="form_img"></a>
			</div>
	 	</div>
	{{/each}}
	</div>
</template>

<template name="avatarList">
	<div class="under_ground">
		<div class="perspective_grid">
		{{#each avatars}}
			<div class="avatar_image" id="{{avatar_id}}"> 
				<div class="player" style="top:{{avatar_top}}px; left:{{avatar_left}}px">{{avatar_name}}</div> 
				<img src="img/{{avatar_img}}" alt="{{avatar_name}}" id="{{avatar_id}}" class="player player_size" style="top:{{avatar_top}}px; left:{{avatar_left}}px"> 
			</div>
		{{/each}}
		{{>npcList}}
		</div>
	</div>
</template>

<template name="npcList">
	<div class="perspective_npc_grid">
	{{#each npcs}}
		<div class="npc_image npc" id="{{id}}"> 
		<div class="npc_message" id="npc_message_{{id}}" style="display:hidden">{{{npc_message}}}</div>
			<img src="img/{{img}}" class="npc" alt="{{name}}" style="top:{{p_y}}px; left:{{p_x}}px; height:{{h}}px;">
		</div>
	{{/each}}
	</div>
</template>

<template name="chat">
{{#if showchat}}	
	<div class="messages">
		{{#if currentUser}}		
		
	 		<div class="text"> 		
				{{> messages}}
			</div>
			
			{{> chat_message}}
			<a id="hidechat" class="hide_chat"> Hide chat ▾</a> 
					<a class="contracted_chat" id="contract_left">Size ▾</a>
	
					<a class="expand_chat" id="expand_right">Expand ▾</a>
					<a class="onmiHal" id="onmiHal">OmniHal ▾</a>
		{{else}}
			{{> secret_form}}
		{{/if}}			
	</div>
{{else}}
		{{#if currentUser}}	
			<a id="showchat" class="show_chat"> Chat ▾</a>
		{{else}}
			
		{{/if}}
{{/if}}
</template>

<template name="messages">
	{{#each messages}}
		<div class="media">
        	<div class="pull-left avarar_name_time" href="#">
				<img src="img/{{avatar_img}}" alt="{{name}}" style="width:50px; height:50px;">	
        	</div>
	        <div class="media-body" id="{{message_id}}"> 
				<span class="media-heading"> 
					<span class="time"> 
						<small> {{prettifyDate time}} </small>
					</span> 
					<span class="chat_name"> {{name}}: </span>

				
						{{#if currentUser}}
							<span class="remove"></span>
						{{/if}}
				  	<span class="chat_message"> {{message}} </span> 
				</span> 
        	</div>			
	</div>
	{{/each}}
</template>

<template name="chat_message">
	<div class="chat_form">

		{{#with chatuser}}
			 {{user}}:
		{{/with}}
	    <div class="form_input_chat">
			<input type="text" class="form-control" id="message"/> 	
		</div>	
    </div>
</template>

<template name="chat_not_logged_in">
	<div class="messages">
		Login to see messages
	</div>
</template>

<template name="gameboard">		
 <div class="gameboard">
		{{gameboard.name}}  
</div>
<div class="center">
	
	<div class="the_canvas">
		<canvas id="myCanvas" width="1400" height="700"></canvas>
	</div>
</div>
</template>


